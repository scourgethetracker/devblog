<!DOCTYPE html>
<html lang="en-us">

  <head>
  <link href="http://gmpg.org/xfn/11" rel="profile">
  <meta http-equiv="content-type" content="text/html; charset=utf-8">

  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1">

  <title>
    
      Scourge and the Sweeps &middot; 
    
  </title>

  

  <link rel="stylesheet" href="http://localhost:4000/public/css/poole.css">
  <link rel="stylesheet" href="http://localhost:4000/public/css/syntax.css">
  <link rel="stylesheet" href="http://localhost:4000/public/css/lanyon.css">
  <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=PT+Serif:400,400italic,700%7CPT+Sans:400">

  <link rel="apple-touch-icon-precomposed" sizes="144x144" href="http://localhost:4000/public/apple-touch-icon-precomposed.png">
  <link rel="shortcut icon" href="http://localhost:4000/public/favicon.ico">

  <link rel="alternate" type="application/rss+xml" title="RSS" href="http://localhost:4000/atom.xml">

  
</head>


  <body>

    <!-- Target for toggling the sidebar `.sidebar-checkbox` is for regular
     styles, `#sidebar-checkbox` for behavior. -->
<input type="checkbox" class="sidebar-checkbox" id="sidebar-checkbox">

<!-- Toggleable sidebar -->
<div class="sidebar" id="sidebar">
  <div class="sidebar-item">
    <p></p>
  </div>

  <nav class="sidebar-nav">
    <a class="sidebar-nav-item active" href="http://localhost:4000/">Home</a>

    

    
    
      
        
      
    
      
        
      
    
      
        
          <a class="sidebar-nav-item" href="http://localhost:4000/about/">About</a>
        
      
    
      
    

    <a class="sidebar-nav-item" href="https://github.com/scourgethetracker/devblog">GitHub project</a>
    <span class="sidebar-nav-item">Currently v0.99</span>
  </nav>

  <div class="sidebar-item">
    <p>
      &copy; 2023. All rights reserved.
    </p>
  </div>
</div>


    <!-- Wrap is the content to shift when toggling the sidebar. We wrap the
         content to avoid any CSS collisions with our real content. -->
    <div class="wrap">
      <div class="masthead">
        <div class="container">
          <h3 class="masthead-title">
            <a href="/" title="Home">Scourge and the Sweeps</a>
            <small></small>
          </h3>
        </div>
      </div>

      <div class="container content">
        <div class="posts">
  
  <div class="post">
    <h1 class="post-title">
      <a href="http://localhost:4000/automation/python/2023/11/29/Update-QNAP-certs-with-Python/">
        Automating Certificate Updates on QNAP with Python
      </a>
    </h1>

    <span class="post-date">29 Nov 2023</span>

    <h2 id="qnap-and-ssl-ugh-sorta">QNAP and SSL… ugh, sorta.</h2>
<p>I have a QNAP NAS. It’s an older TS-1677X that I got a great deal on when it was new but is still getting QTS updates (currently QTS 5.1.2) and it’s the primary disk store in my homelab.  A few years back I decided to HTTPS-all-the-things and actually created my own CA and used that for my certificate needs. Well, 24-November-2023 finally arrived and I had a choice: update the CA certs and all the certs issued OR use Let’s Encrypt. I chose Let’s Encrypt to make my life easier and its become the defacto cert provider for a number of homelabers that I folow.</p>

<p>If you hae a QNAP NAS then you know that QTS is not the best way to manage <em>anything</em> and requires multiple steps to get a new cert and/or CA installed. One thing that you will also learn quickly is that 4096 bit or ECDSA certs aren’t exactly supported requiring you to either jump through a conversion hoop or do it via command line. Since I didn’t want to bother converting anything from Let’s Encrypt I opted for command line and Python.</p>

<p>If you have SSH enabled on the QNAP you can connect, by default, as the ‘admin’ user. The directory you care about for certs is <code class="language-plaintext highlighter-rouge">/etc/stunnel</code> and the files of notes are:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>backup.cert
backup.key
stunnel.pem
uca.cert
</code></pre></div></div>
<p>If you’re here then I will assume you already have certs from Let’s Encrypt, but if not you can look <a href="https://scourgethetracker.github.io">here</a> for a post on how to get and renew Let’s Encrypt Certs with AWS support or <a href="https://scourgethetracker.github.io">here</a> for a more basic starter.</p>

<h2 id="what-i-wanted-vs-what-i-needed">What I wanted vs what I needed</h2>

<p>I had a semi-clear set of goals in mind when starting this migration from my custom CA solution to Let’s Encrypt:</p>

<ul>
  <li><strong>Semi-Automated Certificate Upload</strong>: whatever I write has to have enough logic to push certs where they need to be without too much hand holding so that I could run this from cron later.</li>
  <li><strong>SSH Key Authentication</strong>: it also needs to be able to use SSH and ssh-keys to connect to the QNAP</li>
  <li><strong>Configurable Paths</strong>: it also needs to know where source and destination data belong, as to be flexible</li>
  <li><strong>Dry Run Mode</strong>: before making actual changes, it simulate the upload process, showing what files would be uploaded and where.</li>
  <li><strong>Restart Services</strong>: there are three services that need restarting every time the certs change</li>
</ul>

<p>I would learn later that I needed:</p>

<ul>
  <li><strong>Delay Between Uploads</strong>: The script waits for a specified time between each file upload to manage QNAP ssh connection annoyances when trying to use a for loop.</li>
</ul>

<h2 id="configs-the-what-and-where">Configs, the what and where</h2>
<p>Before starting I knew I wanted a conf file called <code class="language-plaintext highlighter-rouge">~/.updatenas.conf</code> that contained everyting I needed so nothing was hardcoded in my Pythons script.  When planning out the configuration I learned that one of the files I would be updating, <code class="language-plaintext highlighter-rouge">stunnel.pem</code> was actualy the combiation of two pieces of data a private key and a certificate file so my conf needed to able to account for that.</p>

<p>I eventually settled on a <a href="https://toml.io">TOML</a> conf file that looks like this; since I’m using things directly from the Let’s Encrypt Certbot that are saved on disk those are the paths that made sense.</p>

<div class="language-ini highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nn">[general]</span> <span class="c"># Destination and default dry run options
</span><span class="py">dry_run</span> <span class="p">=</span> <span class="s">true</span>
<span class="py">upload_path</span> <span class="p">=</span> <span class="s">/etc/stunnel</span>

<span class="nn">[ssh_config]</span> <span class="c"># How are we connecting to the QNAP
</span><span class="py">host</span> <span class="p">=</span> <span class="s">qnap.domain</span>
<span class="py">port</span> <span class="p">=</span> <span class="s">22</span>
<span class="py">user</span> <span class="p">=</span> <span class="s">admin</span>
<span class="py">key_path</span> <span class="p">=</span> <span class="s">.ssh/id_rsa</span>

<span class="nn">[stunnel_files]</span> <span class="c"># What goes into the stunnel file
</span><span class="py">cert_file</span> <span class="p">=</span> <span class="s">/certbot/config/archive/domain/cert.pem</span>
<span class="py">key_file</span> <span class="p">=</span> <span class="s">/certbot/config/archive/domain/privkey.pem</span>

<span class="nn">[certificate_files]</span> <span class="c"># What other files go into /etc/stunnel
</span><span class="py">backup_cert</span> <span class="p">=</span> <span class="s">/certbot/config/archive/domain/cert.pem</span>
<span class="py">backup_key</span> <span class="p">=</span> <span class="s">/certbot/config/archive/domain/privkey.pem</span>
<span class="py">uca_pem</span> <span class="p">=</span> <span class="s">/certbot/config/archive/domain/fullchain.pem</span>
</code></pre></div></div>

<h2 id="and-so-our-story-begins">And so our story begins…</h2>

<p>I knew I would need some basic things from Python: os, ssh, temp and conf file support for starters.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="nn">paramiko</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">tempfile</span>
<span class="kn">import</span> <span class="nn">configparser</span>
<span class="kn">import</span> <span class="nn">time</span>
</code></pre></div></div>

<p>The first important task was reading the conf file I came up with and making use of the key+value pairs.</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">read_config</span><span class="p">(</span><span class="n">config_file</span><span class="p">):</span>
    <span class="n">config</span> <span class="o">=</span> <span class="n">configparser</span><span class="p">.</span><span class="n">ConfigParser</span><span class="p">()</span>
    <span class="n">config</span><span class="p">.</span><span class="n">read</span><span class="p">(</span><span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="n">expanduser</span><span class="p">(</span><span class="n">config_file</span><span class="p">))</span>
    <span class="n">general_config</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s">'dry_run'</span><span class="p">:</span> <span class="n">config</span><span class="p">.</span><span class="n">getboolean</span><span class="p">(</span><span class="s">'general'</span><span class="p">,</span> <span class="s">'dry_run'</span><span class="p">,</span> <span class="n">fallback</span><span class="o">=</span><span class="bp">True</span><span class="p">),</span>
        <span class="s">'upload_path'</span><span class="p">:</span> <span class="n">config</span><span class="p">.</span><span class="n">get</span><span class="p">(</span><span class="s">'general'</span><span class="p">,</span> <span class="s">'upload_path'</span><span class="p">,</span> <span class="n">fallback</span><span class="o">=</span><span class="s">'/etc/stunnel'</span><span class="p">)</span>
    <span class="p">}</span>
    <span class="n">ssh_config</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s">'host'</span><span class="p">:</span> <span class="n">config</span><span class="p">[</span><span class="s">'ssh_config'</span><span class="p">][</span><span class="s">'host'</span><span class="p">],</span>
        <span class="s">'port'</span><span class="p">:</span> <span class="nb">int</span><span class="p">(</span><span class="n">config</span><span class="p">[</span><span class="s">'ssh_config'</span><span class="p">][</span><span class="s">'port'</span><span class="p">]),</span>
        <span class="s">'user'</span><span class="p">:</span> <span class="n">config</span><span class="p">[</span><span class="s">'ssh_config'</span><span class="p">][</span><span class="s">'user'</span><span class="p">],</span>
        <span class="s">'key_path'</span><span class="p">:</span> <span class="n">config</span><span class="p">[</span><span class="s">'ssh_config'</span><span class="p">][</span><span class="s">'key_path'</span><span class="p">]</span>
    <span class="p">}</span>
    <span class="n">stunnel_files</span> <span class="o">=</span> <span class="p">(</span>
        <span class="n">config</span><span class="p">[</span><span class="s">'stunnel_files'</span><span class="p">][</span><span class="s">'cert_file'</span><span class="p">],</span>
        <span class="n">config</span><span class="p">[</span><span class="s">'stunnel_files'</span><span class="p">][</span><span class="s">'key_file'</span><span class="p">]</span>
    <span class="p">)</span>
    <span class="n">cert_files</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s">'backup_cert'</span><span class="p">:</span> <span class="n">config</span><span class="p">[</span><span class="s">'certificate_files'</span><span class="p">][</span><span class="s">'backup_cert'</span><span class="p">],</span>
        <span class="s">'backup_key'</span><span class="p">:</span> <span class="n">config</span><span class="p">[</span><span class="s">'certificate_files'</span><span class="p">][</span><span class="s">'backup_key'</span><span class="p">],</span>
        <span class="s">'uca_pem'</span><span class="p">:</span> <span class="n">config</span><span class="p">[</span><span class="s">'certificate_files'</span><span class="p">][</span><span class="s">'uca_pem'</span><span class="p">]</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="n">general_config</span><span class="p">,</span> <span class="n">ssh_config</span><span class="p">,</span> <span class="n">stunnel_files</span><span class="p">,</span> <span class="n">cert_files</span>
</code></pre></div></div>

<p>Next I should get the business of <code class="language-plaintext highlighter-rouge">stunnel.pem</code> out of the way.</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">concatenate_files</span><span class="p">(</span><span class="n">file1</span><span class="p">,</span> <span class="n">file2</span><span class="p">,</span> <span class="n">output_file</span><span class="p">):</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">file1</span><span class="p">,</span> <span class="s">'r'</span><span class="p">)</span> <span class="k">as</span> <span class="n">f1</span><span class="p">,</span> <span class="nb">open</span><span class="p">(</span><span class="n">file2</span><span class="p">,</span> <span class="s">'r'</span><span class="p">)</span> <span class="k">as</span> <span class="n">f2</span><span class="p">,</span> <span class="nb">open</span><span class="p">(</span><span class="n">output_file</span><span class="p">,</span> <span class="s">'w'</span><span class="p">)</span> <span class="k">as</span> <span class="n">out</span><span class="p">:</span>
        <span class="n">out</span><span class="p">.</span><span class="n">write</span><span class="p">(</span><span class="n">f1</span><span class="p">.</span><span class="n">read</span><span class="p">())</span>
        <span class="n">out</span><span class="p">.</span><span class="n">write</span><span class="p">(</span><span class="s">'</span><span class="se">\n</span><span class="s">'</span><span class="p">)</span>
        <span class="n">out</span><span class="p">.</span><span class="n">write</span><span class="p">(</span><span class="n">f2</span><span class="p">.</span><span class="n">read</span><span class="p">())</span>
</code></pre></div></div>

<p>Dry-run, before anything else because if it does not work it breaks the QTS UI.</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">update_certificate</span><span class="p">(</span><span class="n">general_config</span><span class="p">,</span> <span class="n">ssh_config</span><span class="p">,</span> <span class="n">stunnel_files</span><span class="p">,</span> <span class="n">cert_files</span><span class="p">):</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="c1"># Use the configured upload path
</span>        <span class="n">remote_path</span> <span class="o">=</span> <span class="n">general_config</span><span class="p">[</span><span class="s">'upload_path'</span><span class="p">]</span>

        <span class="c1"># Dry run mode
</span>        <span class="k">if</span> <span class="n">general_config</span><span class="p">[</span><span class="s">'dry_run'</span><span class="p">]:</span>
            <span class="k">print</span><span class="p">(</span><span class="s">"Dry run mode: No changes will be made."</span><span class="p">)</span>
            <span class="k">print</span><span class="p">(</span><span class="sa">f</span><span class="s">"Would upload </span><span class="si">{</span><span class="n">cert_files</span><span class="p">[</span><span class="s">'backup_cert'</span><span class="p">]</span><span class="si">}</span><span class="s"> to </span><span class="si">{</span><span class="n">ssh_config</span><span class="p">[</span><span class="s">'host'</span><span class="p">]</span><span class="si">}</span><span class="s">:</span><span class="si">{</span><span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="n">join</span><span class="p">(</span><span class="n">remote_path</span><span class="p">,</span> <span class="s">'backup.cert'</span><span class="p">)</span><span class="si">}</span><span class="s">"</span><span class="p">)</span>
            <span class="k">print</span><span class="p">(</span><span class="sa">f</span><span class="s">"Would upload </span><span class="si">{</span><span class="n">cert_files</span><span class="p">[</span><span class="s">'backup_key'</span><span class="p">]</span><span class="si">}</span><span class="s"> to </span><span class="si">{</span><span class="n">ssh_config</span><span class="p">[</span><span class="s">'host'</span><span class="p">]</span><span class="si">}</span><span class="s">:</span><span class="si">{</span><span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="n">join</span><span class="p">(</span><span class="n">remote_path</span><span class="p">,</span> <span class="s">'backup.key'</span><span class="p">)</span><span class="si">}</span><span class="s">"</span><span class="p">)</span>
            <span class="k">print</span><span class="p">(</span><span class="sa">f</span><span class="s">"Would upload </span><span class="si">{</span><span class="n">cert_files</span><span class="p">[</span><span class="s">'uca_pem'</span><span class="p">]</span><span class="si">}</span><span class="s"> to </span><span class="si">{</span><span class="n">ssh_config</span><span class="p">[</span><span class="s">'host'</span><span class="p">]</span><span class="si">}</span><span class="s">:</span><span class="si">{</span><span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="n">join</span><span class="p">(</span><span class="n">remote_path</span><span class="p">,</span> <span class="s">'uca.pem'</span><span class="p">)</span><span class="si">}</span><span class="s">"</span><span class="p">)</span>
            <span class="k">print</span><span class="p">(</span><span class="sa">f</span><span class="s">"Would create stunnel.pem from </span><span class="si">{</span><span class="n">stunnel_files</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s"> and </span><span class="si">{</span><span class="n">stunnel_files</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="si">}</span><span class="s"> at </span><span class="si">{</span><span class="n">ssh_config</span><span class="p">[</span><span class="s">'host'</span><span class="p">]</span><span class="si">}</span><span class="s">:</span><span class="si">{</span><span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="n">join</span><span class="p">(</span><span class="n">remote_path</span><span class="p">,</span> <span class="s">'stunnel.pem'</span><span class="p">)</span><span class="si">}</span><span class="s">"</span><span class="p">)</span>
            <span class="k">return</span>
</code></pre></div></div>

<p>Now I started with this for uploading files to the QNAP with a slight delay to account for the write cache but aftter one or two uploads it would just fail to write files correctly.</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># Establish an SSH client
</span><span class="n">ssh</span> <span class="o">=</span> <span class="n">paramiko</span><span class="p">.</span><span class="n">SSHClient</span><span class="p">()</span>
<span class="n">ssh</span><span class="p">.</span><span class="n">set_missing_host_key_policy</span><span class="p">(</span><span class="n">paramiko</span><span class="p">.</span><span class="n">AutoAddPolicy</span><span class="p">())</span>
<span class="n">ssh_key</span> <span class="o">=</span> <span class="n">paramiko</span><span class="p">.</span><span class="n">RSAKey</span><span class="p">.</span><span class="n">from_private_key_file</span><span class="p">(</span><span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="n">expanduser</span><span class="p">(</span><span class="n">ssh_config</span><span class="p">[</span><span class="s">'key_path'</span><span class="p">]))</span>
<span class="n">ssh</span><span class="p">.</span><span class="n">connect</span><span class="p">(</span><span class="n">ssh_config</span><span class="p">[</span><span class="s">'host'</span><span class="p">],</span> <span class="n">port</span><span class="o">=</span><span class="n">ssh_config</span><span class="p">[</span><span class="s">'port'</span><span class="p">],</span> <span class="n">username</span><span class="o">=</span><span class="n">ssh_config</span><span class="p">[</span><span class="s">'user'</span><span class="p">],</span> <span class="n">pkey</span><span class="o">=</span><span class="n">ssh_key</span><span class="p">)</span>


<span class="n">sftp</span> <span class="o">=</span> <span class="n">ssh</span><span class="p">.</span><span class="n">open_sftp</span><span class="p">()</span>
<span class="k">for</span> <span class="n">local_file</span><span class="p">,</span> <span class="n">remote_file</span> <span class="ow">in</span> <span class="n">cert_files</span><span class="p">.</span><span class="n">items</span><span class="p">():</span>
    <span class="n">sftp</span><span class="p">.</span><span class="n">put</span><span class="p">(</span><span class="n">local_file</span><span class="p">,</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="n">join</span><span class="p">(</span><span class="n">remote_path</span><span class="p">,</span> <span class="n">remote_file</span><span class="p">))</span>
    <span class="k">print</span><span class="p">(</span><span class="sa">f</span><span class="s">"Uploaded </span><span class="si">{</span><span class="n">local_file</span><span class="si">}</span><span class="s"> to </span><span class="si">{</span><span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="n">join</span><span class="p">(</span><span class="n">remote_path</span><span class="p">,</span> <span class="n">remote_file</span><span class="p">)</span><span class="si">}</span><span class="s">"</span><span class="p">)</span>
    <span class="n">time</span><span class="p">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>
</code></pre></div></div>
<p>However, I ended up mupliple instances of this (each with a slight tweak) to account for the issue I was seeing. I’m still not sure if it’s just my QNAP, paramiko, or even the firewall that exists between my desktop and the NAS in my homelab but whatever this cause this worked around the ‘bug’.</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># Upload backup.cert
</span><span class="n">sftp</span><span class="p">.</span><span class="n">put</span><span class="p">(</span><span class="n">cert_files</span><span class="p">[</span><span class="s">'backup_cert'</span><span class="p">],</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="n">join</span><span class="p">(</span><span class="n">remote_path</span><span class="p">,</span> <span class="s">'backup.cert'</span><span class="p">))</span>
<span class="k">print</span><span class="p">(</span><span class="sa">f</span><span class="s">"Uploaded </span><span class="si">{</span><span class="n">cert_files</span><span class="p">[</span><span class="s">'backup_cert'</span><span class="p">]</span><span class="si">}</span><span class="s"> to </span><span class="si">{</span><span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="n">join</span><span class="p">(</span><span class="n">remote_path</span><span class="p">,</span> <span class="s">'backup.cert'</span><span class="p">)</span><span class="si">}</span><span class="s">"</span><span class="p">)</span>
<span class="n">time</span><span class="p">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
</code></pre></div></div>

<p>This worked for <code class="language-plaintext highlighter-rouge">stunnel.pem</code> so I went with what worked.</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># Concatenate stunnel files and upload
</span><span class="k">with</span> <span class="n">tempfile</span><span class="p">.</span><span class="n">NamedTemporaryFile</span><span class="p">(</span><span class="n">delete</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span> <span class="k">as</span> <span class="n">tmp</span><span class="p">:</span>
    <span class="n">concatenate_files</span><span class="p">(</span><span class="n">stunnel_files</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">stunnel_files</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">tmp</span><span class="p">.</span><span class="n">name</span><span class="p">)</span>
    <span class="n">sftp</span><span class="p">.</span><span class="n">put</span><span class="p">(</span><span class="n">tmp</span><span class="p">.</span><span class="n">name</span><span class="p">,</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="n">join</span><span class="p">(</span><span class="n">remote_path</span><span class="p">,</span> <span class="s">'stunnel.pem'</span><span class="p">))</span>
    <span class="k">print</span><span class="p">(</span><span class="sa">f</span><span class="s">"Created and uploaded stunnel.pem from </span><span class="si">{</span><span class="n">stunnel_files</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s"> and </span><span class="si">{</span><span class="n">stunnel_files</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="si">}</span><span class="s"> to </span><span class="si">{</span><span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="n">join</span><span class="p">(</span><span class="n">remote_path</span><span class="p">,</span> <span class="s">'stunnel.pem'</span><span class="p">)</span><span class="si">}</span><span class="s">"</span><span class="p">)</span>
<span class="n">os</span><span class="p">.</span><span class="n">remove</span><span class="p">(</span><span class="n">tmp</span><span class="p">.</span><span class="n">name</span><span class="p">)</span>
</code></pre></div></div>

<p>With all the files updated I needed to restart some services and hope I could log into the QTS gui after.</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># Execute restart scripts
</span><span class="n">restart_scripts</span> <span class="o">=</span> <span class="p">[</span><span class="s">"/etc/init.d/thttpd.sh restart"</span><span class="p">,</span> <span class="s">"/etc/init.d/stunnel.sh restart"</span><span class="p">,</span> <span class="s">"/etc/init.d/Qthttpd.sh restart"</span><span class="p">]</span>
<span class="k">for</span> <span class="n">script</span> <span class="ow">in</span> <span class="n">restart_scripts</span><span class="p">:</span>
    <span class="n">stdin</span><span class="p">,</span> <span class="n">stdout</span><span class="p">,</span> <span class="n">stderr</span> <span class="o">=</span> <span class="n">ssh</span><span class="p">.</span><span class="n">exec_command</span><span class="p">(</span><span class="n">script</span><span class="p">)</span>
    <span class="k">print</span><span class="p">(</span><span class="sa">f</span><span class="s">"Executed: </span><span class="si">{</span><span class="n">script</span><span class="si">}</span><span class="s">"</span><span class="p">)</span>
    <span class="n">time</span><span class="p">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>
</code></pre></div></div>
<p>Each of the parts individually worked well during the many rounds of testing so it’s time to glue them together and hope for the best, right?</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="nn">paramiko</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">tempfile</span>
<span class="kn">import</span> <span class="nn">configparser</span>
<span class="kn">import</span> <span class="nn">time</span>

<span class="k">def</span> <span class="nf">read_config</span><span class="p">(</span><span class="n">config_file</span><span class="p">):</span>
    <span class="n">config</span> <span class="o">=</span> <span class="n">configparser</span><span class="p">.</span><span class="n">ConfigParser</span><span class="p">()</span>
    <span class="n">config</span><span class="p">.</span><span class="n">read</span><span class="p">(</span><span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="n">expanduser</span><span class="p">(</span><span class="n">config_file</span><span class="p">))</span>
    <span class="n">general_config</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s">'dry_run'</span><span class="p">:</span> <span class="n">config</span><span class="p">.</span><span class="n">getboolean</span><span class="p">(</span><span class="s">'general'</span><span class="p">,</span> <span class="s">'dry_run'</span><span class="p">,</span> <span class="n">fallback</span><span class="o">=</span><span class="bp">True</span><span class="p">),</span>
        <span class="s">'upload_path'</span><span class="p">:</span> <span class="n">config</span><span class="p">.</span><span class="n">get</span><span class="p">(</span><span class="s">'general'</span><span class="p">,</span> <span class="s">'upload_path'</span><span class="p">,</span> <span class="n">fallback</span><span class="o">=</span><span class="s">'/etc/stunnel'</span><span class="p">)</span>
    <span class="p">}</span>
    <span class="n">ssh_config</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s">'host'</span><span class="p">:</span> <span class="n">config</span><span class="p">[</span><span class="s">'ssh_config'</span><span class="p">][</span><span class="s">'host'</span><span class="p">],</span>
        <span class="s">'port'</span><span class="p">:</span> <span class="nb">int</span><span class="p">(</span><span class="n">config</span><span class="p">[</span><span class="s">'ssh_config'</span><span class="p">][</span><span class="s">'port'</span><span class="p">]),</span>
        <span class="s">'user'</span><span class="p">:</span> <span class="n">config</span><span class="p">[</span><span class="s">'ssh_config'</span><span class="p">][</span><span class="s">'user'</span><span class="p">],</span>
        <span class="s">'key_path'</span><span class="p">:</span> <span class="n">config</span><span class="p">[</span><span class="s">'ssh_config'</span><span class="p">][</span><span class="s">'key_path'</span><span class="p">]</span>
    <span class="p">}</span>
    <span class="n">stunnel_files</span> <span class="o">=</span> <span class="p">(</span>
        <span class="n">config</span><span class="p">[</span><span class="s">'stunnel_files'</span><span class="p">][</span><span class="s">'cert_file'</span><span class="p">],</span>
        <span class="n">config</span><span class="p">[</span><span class="s">'stunnel_files'</span><span class="p">][</span><span class="s">'key_file'</span><span class="p">]</span>
    <span class="p">)</span>
    <span class="n">cert_files</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s">'backup_cert'</span><span class="p">:</span> <span class="n">config</span><span class="p">[</span><span class="s">'certificate_files'</span><span class="p">][</span><span class="s">'backup_cert'</span><span class="p">],</span>
        <span class="s">'backup_key'</span><span class="p">:</span> <span class="n">config</span><span class="p">[</span><span class="s">'certificate_files'</span><span class="p">][</span><span class="s">'backup_key'</span><span class="p">],</span>
        <span class="s">'uca_pem'</span><span class="p">:</span> <span class="n">config</span><span class="p">[</span><span class="s">'certificate_files'</span><span class="p">][</span><span class="s">'uca_pem'</span><span class="p">]</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="n">general_config</span><span class="p">,</span> <span class="n">ssh_config</span><span class="p">,</span> <span class="n">stunnel_files</span><span class="p">,</span> <span class="n">cert_files</span>

<span class="k">def</span> <span class="nf">concatenate_files</span><span class="p">(</span><span class="n">file1</span><span class="p">,</span> <span class="n">file2</span><span class="p">,</span> <span class="n">output_file</span><span class="p">):</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">file1</span><span class="p">,</span> <span class="s">'r'</span><span class="p">)</span> <span class="k">as</span> <span class="n">f1</span><span class="p">,</span> <span class="nb">open</span><span class="p">(</span><span class="n">file2</span><span class="p">,</span> <span class="s">'r'</span><span class="p">)</span> <span class="k">as</span> <span class="n">f2</span><span class="p">,</span> <span class="nb">open</span><span class="p">(</span><span class="n">output_file</span><span class="p">,</span> <span class="s">'w'</span><span class="p">)</span> <span class="k">as</span> <span class="n">out</span><span class="p">:</span>
        <span class="n">out</span><span class="p">.</span><span class="n">write</span><span class="p">(</span><span class="n">f1</span><span class="p">.</span><span class="n">read</span><span class="p">())</span>
        <span class="n">out</span><span class="p">.</span><span class="n">write</span><span class="p">(</span><span class="s">'</span><span class="se">\n</span><span class="s">'</span><span class="p">)</span>
        <span class="n">out</span><span class="p">.</span><span class="n">write</span><span class="p">(</span><span class="n">f2</span><span class="p">.</span><span class="n">read</span><span class="p">())</span>

<span class="k">def</span> <span class="nf">update_certificate</span><span class="p">(</span><span class="n">general_config</span><span class="p">,</span> <span class="n">ssh_config</span><span class="p">,</span> <span class="n">stunnel_files</span><span class="p">,</span> <span class="n">cert_files</span><span class="p">):</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="c1"># Use the configured upload path
</span>        <span class="n">remote_path</span> <span class="o">=</span> <span class="n">general_config</span><span class="p">[</span><span class="s">'upload_path'</span><span class="p">]</span>

        <span class="c1"># Dry run mode
</span>        <span class="k">if</span> <span class="n">general_config</span><span class="p">[</span><span class="s">'dry_run'</span><span class="p">]:</span>
            <span class="k">print</span><span class="p">(</span><span class="s">"Dry run mode: No changes will be made."</span><span class="p">)</span>
            <span class="k">print</span><span class="p">(</span><span class="sa">f</span><span class="s">"Would upload </span><span class="si">{</span><span class="n">cert_files</span><span class="p">[</span><span class="s">'backup_cert'</span><span class="p">]</span><span class="si">}</span><span class="s"> to </span><span class="si">{</span><span class="n">ssh_config</span><span class="p">[</span><span class="s">'host'</span><span class="p">]</span><span class="si">}</span><span class="s">:</span><span class="si">{</span><span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="n">join</span><span class="p">(</span><span class="n">remote_path</span><span class="p">,</span> <span class="s">'backup.cert'</span><span class="p">)</span><span class="si">}</span><span class="s">"</span><span class="p">)</span>
            <span class="k">print</span><span class="p">(</span><span class="sa">f</span><span class="s">"Would upload </span><span class="si">{</span><span class="n">cert_files</span><span class="p">[</span><span class="s">'backup_key'</span><span class="p">]</span><span class="si">}</span><span class="s"> to </span><span class="si">{</span><span class="n">ssh_config</span><span class="p">[</span><span class="s">'host'</span><span class="p">]</span><span class="si">}</span><span class="s">:</span><span class="si">{</span><span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="n">join</span><span class="p">(</span><span class="n">remote_path</span><span class="p">,</span> <span class="s">'backup.key'</span><span class="p">)</span><span class="si">}</span><span class="s">"</span><span class="p">)</span>
            <span class="k">print</span><span class="p">(</span><span class="sa">f</span><span class="s">"Would upload </span><span class="si">{</span><span class="n">cert_files</span><span class="p">[</span><span class="s">'uca_pem'</span><span class="p">]</span><span class="si">}</span><span class="s"> to </span><span class="si">{</span><span class="n">ssh_config</span><span class="p">[</span><span class="s">'host'</span><span class="p">]</span><span class="si">}</span><span class="s">:</span><span class="si">{</span><span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="n">join</span><span class="p">(</span><span class="n">remote_path</span><span class="p">,</span> <span class="s">'uca.pem'</span><span class="p">)</span><span class="si">}</span><span class="s">"</span><span class="p">)</span>
            <span class="k">print</span><span class="p">(</span><span class="sa">f</span><span class="s">"Would create stunnel.pem from </span><span class="si">{</span><span class="n">stunnel_files</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s"> and </span><span class="si">{</span><span class="n">stunnel_files</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="si">}</span><span class="s"> at </span><span class="si">{</span><span class="n">ssh_config</span><span class="p">[</span><span class="s">'host'</span><span class="p">]</span><span class="si">}</span><span class="s">:</span><span class="si">{</span><span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="n">join</span><span class="p">(</span><span class="n">remote_path</span><span class="p">,</span> <span class="s">'stunnel.pem'</span><span class="p">)</span><span class="si">}</span><span class="s">"</span><span class="p">)</span>
            <span class="k">return</span>

        <span class="c1"># Establish an SSH client
</span>        <span class="n">ssh</span> <span class="o">=</span> <span class="n">paramiko</span><span class="p">.</span><span class="n">SSHClient</span><span class="p">()</span>
        <span class="n">ssh</span><span class="p">.</span><span class="n">set_missing_host_key_policy</span><span class="p">(</span><span class="n">paramiko</span><span class="p">.</span><span class="n">AutoAddPolicy</span><span class="p">())</span>
        <span class="n">ssh_key</span> <span class="o">=</span> <span class="n">paramiko</span><span class="p">.</span><span class="n">RSAKey</span><span class="p">.</span><span class="n">from_private_key_file</span><span class="p">(</span><span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="n">expanduser</span><span class="p">(</span><span class="n">ssh_config</span><span class="p">[</span><span class="s">'key_path'</span><span class="p">]))</span>
        <span class="n">ssh</span><span class="p">.</span><span class="n">connect</span><span class="p">(</span><span class="n">ssh_config</span><span class="p">[</span><span class="s">'host'</span><span class="p">],</span> <span class="n">port</span><span class="o">=</span><span class="n">ssh_config</span><span class="p">[</span><span class="s">'port'</span><span class="p">],</span> <span class="n">username</span><span class="o">=</span><span class="n">ssh_config</span><span class="p">[</span><span class="s">'user'</span><span class="p">],</span> <span class="n">pkey</span><span class="o">=</span><span class="n">ssh_key</span><span class="p">)</span>

        <span class="n">sftp</span> <span class="o">=</span> <span class="n">ssh</span><span class="p">.</span><span class="n">open_sftp</span><span class="p">()</span>

        <span class="c1"># Upload backup.cert
</span>        <span class="n">sftp</span><span class="p">.</span><span class="n">put</span><span class="p">(</span><span class="n">cert_files</span><span class="p">[</span><span class="s">'backup_cert'</span><span class="p">],</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="n">join</span><span class="p">(</span><span class="n">remote_path</span><span class="p">,</span> <span class="s">'backup.cert'</span><span class="p">))</span>
        <span class="k">print</span><span class="p">(</span><span class="sa">f</span><span class="s">"Uploaded </span><span class="si">{</span><span class="n">cert_files</span><span class="p">[</span><span class="s">'backup_cert'</span><span class="p">]</span><span class="si">}</span><span class="s"> to </span><span class="si">{</span><span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="n">join</span><span class="p">(</span><span class="n">remote_path</span><span class="p">,</span> <span class="s">'backup.cert'</span><span class="p">)</span><span class="si">}</span><span class="s">"</span><span class="p">)</span>
        <span class="n">time</span><span class="p">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

        <span class="c1"># Upload backup.key
</span>        <span class="n">sftp</span><span class="p">.</span><span class="n">put</span><span class="p">(</span><span class="n">cert_files</span><span class="p">[</span><span class="s">'backup_key'</span><span class="p">],</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="n">join</span><span class="p">(</span><span class="n">remote_path</span><span class="p">,</span> <span class="s">'backup.key'</span><span class="p">))</span>
        <span class="k">print</span><span class="p">(</span><span class="sa">f</span><span class="s">"Uploaded </span><span class="si">{</span><span class="n">cert_files</span><span class="p">[</span><span class="s">'backup_key'</span><span class="p">]</span><span class="si">}</span><span class="s"> to </span><span class="si">{</span><span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="n">join</span><span class="p">(</span><span class="n">remote_path</span><span class="p">,</span> <span class="s">'backup.key'</span><span class="p">)</span><span class="si">}</span><span class="s">"</span><span class="p">)</span>
        <span class="n">time</span><span class="p">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

        <span class="c1"># Upload uca.pem
</span>        <span class="n">sftp</span><span class="p">.</span><span class="n">put</span><span class="p">(</span><span class="n">cert_files</span><span class="p">[</span><span class="s">'uca_pem'</span><span class="p">],</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="n">join</span><span class="p">(</span><span class="n">remote_path</span><span class="p">,</span> <span class="s">'uca.pem'</span><span class="p">))</span>
        <span class="k">print</span><span class="p">(</span><span class="sa">f</span><span class="s">"Uploaded </span><span class="si">{</span><span class="n">cert_files</span><span class="p">[</span><span class="s">'uca_pem'</span><span class="p">]</span><span class="si">}</span><span class="s"> to </span><span class="si">{</span><span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="n">join</span><span class="p">(</span><span class="n">remote_path</span><span class="p">,</span> <span class="s">'uca.pem'</span><span class="p">)</span><span class="si">}</span><span class="s">"</span><span class="p">)</span>
        <span class="n">time</span><span class="p">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

        <span class="c1"># Concatenate stunnel files and upload
</span>        <span class="k">with</span> <span class="n">tempfile</span><span class="p">.</span><span class="n">NamedTemporaryFile</span><span class="p">(</span><span class="n">delete</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span> <span class="k">as</span> <span class="n">tmp</span><span class="p">:</span>
            <span class="n">concatenate_files</span><span class="p">(</span><span class="n">stunnel_files</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">stunnel_files</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">tmp</span><span class="p">.</span><span class="n">name</span><span class="p">)</span>
            <span class="n">sftp</span><span class="p">.</span><span class="n">put</span><span class="p">(</span><span class="n">tmp</span><span class="p">.</span><span class="n">name</span><span class="p">,</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="n">join</span><span class="p">(</span><span class="n">remote_path</span><span class="p">,</span> <span class="s">'stunnel.pem'</span><span class="p">))</span>
            <span class="k">print</span><span class="p">(</span><span class="sa">f</span><span class="s">"Created and uploaded stunnel.pem from </span><span class="si">{</span><span class="n">stunnel_files</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s"> and </span><span class="si">{</span><span class="n">stunnel_files</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="si">}</span><span class="s"> to </span><span class="si">{</span><span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="n">join</span><span class="p">(</span><span class="n">remote_path</span><span class="p">,</span> <span class="s">'stunnel.pem'</span><span class="p">)</span><span class="si">}</span><span class="s">"</span><span class="p">)</span>
        <span class="n">os</span><span class="p">.</span><span class="n">remove</span><span class="p">(</span><span class="n">tmp</span><span class="p">.</span><span class="n">name</span><span class="p">)</span>

        <span class="c1"># Execute restart scripts
</span>        <span class="n">restart_scripts</span> <span class="o">=</span> <span class="p">[</span><span class="s">"/etc/init.d/thttpd.sh restart"</span><span class="p">,</span> <span class="s">"/etc/init.d/stunnel.sh restart"</span><span class="p">,</span> <span class="s">"/etc/init.d/Qthttpd.sh restart"</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">script</span> <span class="ow">in</span> <span class="n">restart_scripts</span><span class="p">:</span>
            <span class="n">stdin</span><span class="p">,</span> <span class="n">stdout</span><span class="p">,</span> <span class="n">stderr</span> <span class="o">=</span> <span class="n">ssh</span><span class="p">.</span><span class="n">exec_command</span><span class="p">(</span><span class="n">script</span><span class="p">)</span>
            <span class="k">print</span><span class="p">(</span><span class="sa">f</span><span class="s">"Executed: </span><span class="si">{</span><span class="n">script</span><span class="si">}</span><span class="s">"</span><span class="p">)</span>
            <span class="n">time</span><span class="p">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>

        <span class="n">sftp</span><span class="p">.</span><span class="n">close</span><span class="p">()</span>
        <span class="n">ssh</span><span class="p">.</span><span class="n">close</span><span class="p">()</span>
        <span class="k">print</span><span class="p">(</span><span class="s">"Certificate update completed successfully."</span><span class="p">)</span>

    <span class="k">except</span> <span class="nb">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="k">print</span><span class="p">(</span><span class="sa">f</span><span class="s">"An error occurred: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s">"</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">main</span><span class="p">():</span>
    <span class="n">general_config</span><span class="p">,</span> <span class="n">ssh_config</span><span class="p">,</span> <span class="n">stunnel_files</span><span class="p">,</span> <span class="n">cert_files</span> <span class="o">=</span> <span class="n">read_config</span><span class="p">(</span><span class="s">'./updatenas.conf'</span><span class="p">)</span>
    <span class="n">update_certificate</span><span class="p">(</span><span class="n">general_config</span><span class="p">,</span> <span class="n">ssh_config</span><span class="p">,</span> <span class="n">stunnel_files</span><span class="p">,</span> <span class="n">cert_files</span><span class="p">)</span>

<span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="s">"__main__"</span><span class="p">:</span>
    <span class="n">main</span><span class="p">()</span>
</code></pre></div></div>
<p>Well slap-ya-mama and call it done. I have to admit I was a bit surpised when it worked the first time round with the required bit to make is a cohesive script in place. Nonetheless, I was a happy camper and could cross that off my list.</p>

<p>Now I need to do the same for my OPNSense firewall… hmmmm.</p>

<p>If you want a complete script and example conf without having to copy and paste, check out my Github repo at <a href="https://github.com/scourgethetracker/devblog">ScourgeTheTracker/devblog</a>.</p>

  </div>
  
</div>

<div class="pagination">
  
    <span class="pagination-item older">Older</span>
  
  
    <span class="pagination-item newer">Newer</span>
  
</div>

      </div>
    </div>

    <label for="sidebar-checkbox" class="sidebar-toggle"></label>

    <script src='/public/js/script.js'></script>
  </body>
</html>
